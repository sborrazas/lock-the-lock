FROM node:14.12.0 AS assets

ADD ./assets /app
WORKDIR /app

RUN npm install

RUN npm run build

FROM elixir:1.11.1 AS build

ARG APP_VERSION

# Install hex
RUN mix local.hex --force

# Install rebar
RUN mix local.rebar --force

# Add app & assets
ADD . /app
COPY --from=assets /app/build /app/priv/static
WORKDIR /app

# Set env
ENV MIX_ENV prod
ENV APP_VERSION $APP_VERSION
ENV APP_PORT 3000

# Install deps
RUN mix deps.get --only prod

# Digest assets
RUN mix phx.digest

# Build release
RUN mix release lock_the_lock

FROM elixir:1.11.1

# Set env
ENV MIX_ENV prod
ENV APP_PORT 3000

COPY --from=build /app/_build/prod/rel/lock_the_lock /app

# Run
EXPOSE 3000

ENTRYPOINT ["/app/bin/lock_the_lock", "start"]
